<div class="container-fluid">
  <div class="row g-4">
    <div class="col-3">
      <div class="card  p-5 mt-3 ms-3 ">

        <div class="card-img-top-container">
          <img src="lubiv.png"
               class="card-img-top"
               alt="Profile silhouette">
        </div>
        <div class="card-body text-center">
          <h2>Welcome, {{ currentUser?.username }}!</h2>
          <p><strong>Email:</strong> {{ currentUser?.email }}</p>
          <p><strong>Role:</strong> {{ currentUser?.role }}</p>
        </div>

        <div class="card-footer text-center">
          <button class="btn btn-outline-primary btn-sm mx-auto" (click)="handleOpenEditModal()"><i class="bi-pencil-fill"></i>Edit</button>
        </div>
      </div>

      <div class="card mt-3 ms-3">
        <div class="card-img">
          <img src="https://media1.tenor.com/m/hs6IuO3pDh8AAAAd/pixel-art.gif"
               alt="i am bored"
               style="width: 100%; height: auto;"

          >
        </div>
      </div>
    </div>
    <div class="col-9">
      @if (isLoading) {
        <div class="text-center p-4">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>Loading purchases...</p>
        </div>
      } @else if (error) {
        <div class="alert alert-danger">{{ error }}</div>
      } @else if (purchaseLog.length > 0) {
        <div class="mt-3 text-center">
        <h2 >Purchase log</h2>

        </div>
        @for (purchase of purchaseLog; track purchase.id) {
          <div class="card mt-3">
            <div class="card-body ">
              <div class="row align-items-center">

                <div class="col-3">
                  <strong>Purchase no : {{ purchase.id }}</strong>
                </div>

                <div class="col-3">
                  {{ purchase.date | date:'short' }}
                </div>

                <div class="col-3">
                  Total : {{ purchase.totalAmount }}₺
                </div>

                <div class="col-3">
                  <button class="btn btn-outline-primary w-auto w-md-auto"
                          (click)="togglePurchasedProducts(purchase.id)">
                    <i class="bi" [class]="getIcon(purchase.id)"></i>
                    view
                  </button>
                </div>

              </div>
            </div>
          </div>

          @if (isExpanded(purchase.id)) {
            @if (isLoading) {
              <div class="text-center">
                <div class="spinner-border"></div>
                <p>Loading items...</p>
              </div>
            } @else if (error) {
              <div class="alert alert-danger">{{ error }}</div>
            }
            <!-- Enhanced Table Version -->
            @if (purchasedProducts.length > 0) {
              <div class="purchase-table mt-3">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                      <th class="text-center">Product Name</th>
                      <th class="text-center">Price</th>
                      <th class="text-center">Quantity</th>
                    </tr>
                    </thead>
                    <tbody>
                      @for(product of purchasedProducts; track product.id) {
                        <tr>
                          <td class="text-center">
                            <span class="product-name">{{ product.productName }}</span>
                          </td>
                          <td class="text-center">
                            <span class="price-tag">{{ product.currentPrice }}₺</span>
                          </td>
                          <td class="text-center">
                <span class="quantity-badge">
                  <i class="bi bi-box"></i>
                  {{ product.quantity }}
                </span>
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            } @else {
              <div class="purchase-table mt-3">
                <div class="table-header">
                  <h5>
                    <i class="bi bi-cart-check text-success"></i>
                    Purchased Items
                  </h5>
                </div>
                <div class="empty-state">
                  <i class="bi bi-inbox text-muted"></i>
                  <p class="mb-0">No products found for this purchase</p>
                </div>
              </div>
            }
          }

        }
      } @else {
        <div class="d-flex justify-content-center align-items-center vh-100 bg-light mt-3">
          <div class="text-center">
            <p class="text-muted mb-0 fs-3">
              <i class="bi bi-inbox me-2 fs-1"></i>
              <br>
              No purchases made yet
            </p>
          </div>
        </div>
      }
    </div>
  </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"> Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <app-client-profile-edit
          [userData]="currentUser"
          (onSave)="handleSave()"
          (onCancel)="handleCancel()"
        >
        </app-client-profile-edit>

      </div>
    </div>
  </div>
</div>
